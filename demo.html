<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Air-Launch Demo</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.118/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <style>
    html, body, #cesiumContainer { width:100%; height:100%; margin:0; padding:0; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div style="position: absolute; top: 10px; left: 10px; z-index: 1;">
    <button onclick="viewer.trackedEntity = plane;">Track Plane</button>
    <button onclick="viewer.trackedEntity = rocket;">Track Rocket</button>
    <button onclick="viewer.trackedEntity = payload;">Track Payload</button>
    <button onclick="viewer.zoomTo(viewer.entities);">Zoom to All</button>
  </div>
  <script>
    // Setup Cesium viewer
    Cesium.Ion.defaultAccessToken = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJqdGkiOiJjY2ZiMGU1Ny03YzU3LTRkZmEtYTRlMC0xN2FmY2JkMjExNGIiLCJpZCI6MzQ2MzExLCJpYXQiOjE3NTkzMjQyODF9.UzpcscNpBpN0nlzyzmV2B2g3ahm1w0STY7vEFgGXPCU";
    const viewer = new Cesium.Viewer("cesiumContainer", {
      timeline: true,
      animation: true,
    });

    let plane, rocket, payload;

    // Load trajectory JSON
    fetch("trajectory.json")
      .then(res => {
        if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
        return res.json();
      })
      .then(data => {
        const start = Cesium.JulianDate.fromIso8601(data.plane[0].time);
        const stop = Cesium.JulianDate.fromIso8601(data.rocket[data.rocket.length - 1].time);

        viewer.clock.startTime = start.clone();
        viewer.clock.stopTime = stop.clone();
        viewer.clock.currentTime = start.clone();
        viewer.clock.multiplier = 30; // fast-forward
        viewer.timeline.zoomTo(start, stop);

        // Plane entity with glowing path
        const planePos = new Cesium.SampledPositionProperty();
        data.plane.forEach(p => {
          planePos.addSample(Cesium.JulianDate.fromIso8601(p.time), Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.alt));
        });
        plane = viewer.entities.add({
          name: "Carrier Plane",
          position: planePos,
          orientation: new Cesium.VelocityOrientationProperty(planePos),
          model: { uri: "https://cesium.com/downloads/cesiumjs/releases/1.118/Apps/SampleData/models/CesiumAir/Cesium_Air.glb", scale: 2 },
          path: {
            resolution: 1,
            material: new Cesium.PolylineGlowMaterialProperty({
              glowPower: 0.2, taperPower: 1, color: Cesium.Color.YELLOW
            }),
            width: 10,
          },
          description: "Carrier plane taking off from Indonesia."
        });

        // Rocket entity with glowing path
        const rocketPos = new Cesium.SampledPositionProperty();
        data.rocket.forEach(r => {
          rocketPos.addSample(Cesium.JulianDate.fromIso8601(r.time), Cesium.Cartesian3.fromDegrees(r.lon, r.lat, r.alt));
        });
        rocket = viewer.entities.add({
          name: "Rocket",
          position: rocketPos,
          orientation: new Cesium.VelocityOrientationProperty(rocketPos),
          model: { uri: "https://cesium.com/downloads/cesiumjs/releases/1.118/Apps/SampleData/models/CesiumBalloon/CesiumBalloon.glb", scale: 1.5 },
          path: {
            resolution: 1,
            material: new Cesium.PolylineGlowMaterialProperty({
              glowPower: 0.2, taperPower: 1, color: Cesium.Color.ORANGE
            }),
            width: 10,
          },
          description: "Rocket released from the carrier plane."
        });

        // Payload entity with glowing orbit path
        const payloadPos = new Cesium.SampledPositionProperty();
        data.payload.track.forEach(p => {
          payloadPos.addSample(Cesium.JulianDate.fromIso8601(p.time), Cesium.Cartesian3.fromDegrees(p.lon, p.lat, p.alt));
        });
        payload = viewer.entities.add({
          name: "Payload",
          position: payloadPos,
          orientation: new Cesium.VelocityOrientationProperty(payloadPos),
          model: { uri: "https://cesium.com/downloads/cesiumjs/releases/1.118/Apps/SampleData/models/CesiumMan/Cesium_Man.glb", scale: 5000 },
          path: {
            resolution: 1,
            material: new Cesium.PolylineGlowMaterialProperty({
              glowPower: 0.2, taperPower: 1, color: Cesium.Color.CYAN
            }),
            width: 4,
          },
          description: `Orbit: 500km circular, Inclination: ${data.payload.orbit.inclination}Â°`
        });

        // Camera auto-switching
        viewer.trackedEntity = plane;
        let currentPhase = "plane";

        const rocketSeparationTime = Cesium.JulianDate.addSeconds(start, 120, new Cesium.JulianDate()); // +2 min
        const payloadOrbitTime = Cesium.JulianDate.addSeconds(start, 300, new Cesium.JulianDate()); // +5 min

        viewer.clock.onTick.addEventListener(clock => {
          const now = clock.currentTime;

          if (Cesium.JulianDate.greaterThanOrEquals(now, rocketSeparationTime) && currentPhase === "plane") {
            viewer.trackedEntity = rocket;
            currentPhase = "rocket";
            console.log("ðŸš€ Camera switched to Rocket");
          }

          if (Cesium.JulianDate.greaterThanOrEquals(now, payloadOrbitTime) && currentPhase === "rocket") {
            viewer.trackedEntity = payload;
            currentPhase = "payload";
            console.log("ðŸ›°ï¸ Camera switched to Payload");
          }
        });

      })
      .catch(error => console.error("Error loading trajectory:", error));
  </script>
</body>
</html>
